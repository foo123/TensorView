/**
*  TensorView
*  View array data as multidimensional tensors of various shapes efficiently
*  @VERSION 1.0.0
*  https://github.com/foo123/TensorView
*
**/
!function(n,t){"use strict";"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(function(n){return t()}):n.TensorView=t()}("undefined"!=typeof self?self:this,function(n){"use strict";var t="prototype",k=Math;function V(s,n,t){if(!(this instanceof V))return new V(s,n,t);var u,e,o=this,i=!1,f=!1,a=null,c=null,h=null,p=-1,g=null,d=null,w=!1,y=0,l=null,_=null,m=null,A=null,v=!0,r=0;function b(n,t,e,r,i,o,l){var s,u,f=0;if(l)for(s=0;s<t;++s){if((u=n[s])<0&&(u+=o[s]),u<0||u>=o[s])throw"TensorView:index ("+n[s]+") for dimension ("+s+") is out of bounds (0,"+(o[s]-1)+")!";f+=i[s]*(l[s].start+u*l[s].step)}else for(s=0;s<t;++s){if((u=n[s])<0&&(u+=o[s]),u<0||u>=o[s])throw"TensorView:index ("+n[s]+") for dimension ("+s+") is out of bounds (0,"+(o[s]-1)+")!";f+=i[s]*u}return f}function x(n,t,e,r,i,o,l){var s,u;if(l=l||new Array(t),e)if(o)for(s=0;s<t;++s)u=n%r[s],n=k.floor(n/r[s]),l[s]=k.floor((u-o[s].start)/o[s].step);else for(s=0;s<t;++s)u=n%r[s],n=k.floor(n/r[s]),l[s]=u;else if(o)for(s=t-1;0<=s;--s)u=n%r[s],n=k.floor(n/r[s]),l[s]=k.floor((u-o[s].start)/o[s].step);else for(s=t-1;0<=s;--s)u=n%r[s],n=k.floor(n/r[s]),l[s]=u;return l}function S(n,t,e){for(var r=n,i=t.length-1,o=0;o<i;++o)r=r[t[o]];return 2<arguments.length&&(r[t[i]]=e),r[t[i]]}function j(n,t){if(c)return a?c[1]?a(c[0].get(t),c[1].get(t),c[0],c[1],t):a(c[0].get(t),c[0],t):c[0].get(c[0].indices(n));if(!h)return d?S(s,v&&w?t:x(n,d.length,!1,d,0,null,g)):f?s:s[n];for(var e=0;e<y;++e)g[e]=A[e].start+t[e]*A[e].step;for(var r,i,e=0,o=h.length;e<o;++e){if(i=(r=h[e]).size(p),0<=g[p]&&g[p]<i)return r.get(g);g[p]-=i}}if(n=n||{},i=!!t&&!!t._transposed,s instanceof V)i=!1,s=(c=[s])[0].data(),r=c[0].length(),l=n.shape||c[0].size(),y=l.length;else if(t&&t._refs&&t._refs[0]instanceof V)i=!1,a=t._op||null,c=t._refs,r=c[0].length(),l=(a?c[0].size():n.shape)||c[0].size(),y=l.length,c[1]&&(s=null),a&&n.slice&&(n.slice=null);else if(t&&t._stack&&2<=t._stack.length&&t._stack[0]instanceof V&&t._stack[1]instanceof V)s=null,p=t._stack_axis||0,h=t._stack,(l=h[0].size())[p]=O(h.map(function(n){return n.size(p)})),r=O(h.map(function(n){return n.length()})),y=l.length,g=new Array(y);else{var r=function(n){{if(Array.isArray(n))return 1;if("undefined"!=typeof Float32Array&&n instanceof Object.getPrototypeOf(Float32Array))return 1}return}(s)?(f=!1,n.ndarray&&n.ndarray.length?N(d=n.ndarray):s.length):(f=!0,1),z=N(l=(l=n.shape)&&l.length?l:[r]);if(z!==(r=f?z:r))throw"TensorView:shape ["+l.join(",")+"] does not match size "+String(r);y=l.length,!d||(w=d.length===l.length&&d.length===l.filter(function(n,t){return n===d[t]}).length)||(g=new Array(d.length))}if(_=new Array(y),i)for(e=_[0]=1;e<y;++e)_[e]=_[e-1]*l[e-1];else for(_[y-1]=1,e=y-2;0<=e;--e)_[e]=_[e+1]*l[e+1];if((A=n.slice)&&A.length){for(;A.length<y;)A.push(null);for(A.length>y&&(A.length=y),e=0;e<y;++e)A[e]=A[e]||[0,l[e]-1,1],A[e]=E._indices(l[e],A[e][0],A[e][1],A[e][2]),0===A[e].start&&A[e].stop+1===l[e]&&1===A[e].step||(v=!1)}else for(A=new Array(y),e=0;e<y;++e)A[e]=new E(0,l[e]-1,1);for(m=new Array(y),e=0;e<y;++e)m[e]=A[e].count(l[e]);u=y?N(m):0,n=t=null,o.dispose=function(){m=A=_=l=s=d=g=h=c=a=null},o.data=function(){return s},o.dimension=function(){return y},o.shape=function(n){return arguments.length?l[n]:l.slice()},o.slicing=function(n){return arguments.length?A[n].toObj():A.map(function(n){return n.toObj()})},o.size=function(n){return arguments.length?m[n]:m.slice()},o.length=function(){return u},o.index=function(){return b(Array.isArray(arguments[0])?arguments[0]:arguments,y,0,0,_,m,A)},o.indices=function(n){if(n<0||r<=n)throw"TensorView::indices:index ("+n+") is out of bounds (0,"+(r-1)+")!";return x(n,y,i,l,0,A)},o.get=function(){var n=Array.isArray(arguments[0])?arguments[0]:arguments,t=0;if(n.length<y)throw"TensorView::get:indices do not match shape dimension!";if((t=a||h?t:b(n,y,0,0,_,m,A))<0||r<=t)throw"TensorView::get:index ("+t+") is out of bounds (0,"+(r-1)+")!";return j(t,n)},o.set=function(){var n=arguments,t=arguments.length-1,e=0;if((t=Array.isArray(arguments[0])?(n=arguments[0]).length:t)<y)throw"TensorView::set:indices do not match shape dimension!";if((e=a||h?e:b(n,y,0,0,_,m,A))<0||r<=e)throw"TensorView::set:index ("+e+") is out of bounds (0,"+(r-1)+")!";return function(n,t,e){if(c)a||c[0].set(c[0].indices(n),e);else if(h){for(var r=0;r<y;++r)g[r]=A[r].start+t[r]*A[r].step;for(var i,o,r=0,l=h.length;r<l;++r){if(o=(i=h[r]).size(p),0<=g[p]&&g[p]<o)return i.set(g,e);g[p]-=o}}else d?S(s,v&&w?t:x(n,d.length,!1,d,0,null,g),e):f?s=e:s[n]=e}(e,n,arguments[arguments.length-1]),o},o.iterator=function(){var n=0<u?y-1:-1,t=null,e=null,r=null,i=0,o=[null,null],l={value:null};return{next:function(){if(n<0)return{done:!(t=e=r=l=o=null)};if(t){for(;0<=n&&t[n]+1>=m[n];)i-=r[n].start+t[n]*r[n].step,--n;if(!(0<=n))return{done:!(t=e=r=l=o=null)};for(++t[n],e[n]=t[n],i+=r[n].step;n+1<y;)t[++n]=0,e[n]=0,i+=r[n].start}else t=new Array(y).fill(0),e=t.slice(),r=A.map(function(n,t){return{start:n.start*_[t],step:n.step*_[t]}}),i=b(t,y,0,0,_,m,A);return o[0]=j(i,t),o[1]=e,l.value=o,l}}},o.forEach=function(n){if(0<u&&"function"==typeof n)for(var t,e=o.iterator();;){if(!(t=e.next())||t.done)return;if(!1===n(t.value[0],t.value[1],s,o))return}},o.transpose=function(){return new V(s,{ndarray:d,shape:l.slice().reverse(),slice:A.map(function(n){return n.toArr()}).reverse()},{_transposed:!i,_refs:c?c.map(function(n){return n.transpose()}).reverse():null,_op:a,_stack:h?h.map(function(n){return n.transpose()}):null,_stack_axis:h?y-1-p:-1})},o.slice=function(r){return new V(s,{ndarray:d,shape:a&&c?null:l,slice:a&&c?null:A.map(function(n,t){var e=r[t]||[null,null,null];return n.subslice(E(e[0],e[1],e[2]).indices(l[t])).toArr()})},{_transposed:i,_refs:a&&c?c.map(function(n){return n.slice(r)}):c,_op:a,_stack:c?null:h,_stack_axis:p})},o.reshape=function(n){return!v||h||c?new V(o,{shape:n}):new V(s,{ndarray:d,shape:n})},o.concat=function(e,r){r=r||0;for(var i=0,n=(e=e instanceof V?[e]:e).length;i<n;++i)if(m.filter(function(n,t){return t===r||n===e[i].size(t)}).length!==m.length)throw"TensorView::concat:["+m.map(function(n,t){return r===t?":":n}).join(",")+"] and ["+e[i].size().map(function(n,t){return r===t?":":n}).join(",")+"] sizes do not match!";return new V(null,null,{_stack:[o].concat(e),_stack_axis:r})},o.op=function(n,t){return new V(s,null,{_refs:t instanceof V?[o,t]:[o],_op:n})},o.toArray=function(n){var t=new(n||Array)(u),e=0;return o.forEach(function(n){t[e++]=n}),t},o.toNDArray=function(){var l=y?new Array(m[0]):[];return o.forEach(function(n,t){for(var e,r=l,i=y-1,o=0;o<i;++o)null==r[e=t[o]]&&(r[e]=new Array(m[o+1])),r=r[e];r[t[i]]=n}),l},o.toString=function(l){var s,u,f,a="",c=-1/0,h=null,p="";return null!=l?(s=l>>>1,2<=y?(u=m.map(function(n){return l<n}),f=function(n,t){return!u[t]||t<=y-3&&(n<s||n>m[t]-1-s)||y-3<t&&(n<=s||n>=m[t]-1-s)},h=new Array(u[m.length-2]?l+1:m[m.length-2]).fill(null).map(function(n){return new Array(u[m.length-1]?l+1:m[m.length-1])}),o.forEach(function(n,t){t.length===t.filter(f).length&&(c=k.max(String(n).length,c))}),o.forEach(function(n,t){if(t.length===t.filter(f).length){var e=t[y-2],r=t[y-1];if(u[y-2]&&s<e&&(e=l-(m[y-2]-1-e)),u[y-1]&&s<r&&(r=l-(m[y-1]-1-r)),h[e][r]=T(String(n),c," ",!1),m[y-1]===1+t[y-1]&&m[y-2]===1+t[y-2]){a+=p+h.map(function(n,t){return u[y-2]&&s===t&&(n=new Array(n.length).fill(T(":",c," ",!1))),u[y-1]&&(n[s]=T("..",c," ",!1)),n.join(" ")}).join("\n");for(var i=y-3,o=-1;0<=i;)o=-1===o&&u[i]&&t[i]+1===s?i:o,--i;p=-1===o?"\n-\n":"\n-\n"+T(":",c," ",!1)+" "+new Array((u[y-1]?l+1:m[y-1])-2).fill(T("..",c," ",!1)).join(" ")+" "+T(":",c," ",!1)+"\n-\n"}}})):a=l>=m[0]?o.toString():o.slice([{start:0,stop:s+1}]).toString()+" .. "+o.slice([{start:m[0]-1-s,stop:m[0]-1}]).toString()):2<=y?(h=new Array(m[m.length-2]).fill(null).map(function(n){return new Array(m[m.length-1])}),o.forEach(function(n){c=k.max(String(n).length,c)}),o.forEach(function(n,t){h[t[y-2]][t[y-1]]=T(String(n),c," ",!1),m[y-1]===1+t[y-1]&&m[y-2]===1+t[y-2]&&(a+=p+h.map(function(n){return n.join(" ")}).join("\n"),p="\n-\n")})):o.forEach(function(n){a+=(a.length?" ":"")+String(n)}),a}}function E(n,t,e){if(!(this instanceof E))return new E(n,t,e);this.start=null==n?null:n,this.stop=null==t?null:t,this.step=null==e?null:e}function T(n,t,e,r){t=n.length<t?new Array(t-n.length+1).join(e):"";return r?n+t:t+n}function e(n,t){return n+t}function r(n,t){return n*t}function O(n){return n.reduce(e,0)}function N(n){return n.reduce(r,1)}return V.VERSION="1.0.0",V[t]={constructor:V,dispose:null,data:null,dimension:null,shape:null,slicing:null,size:null,length:null,index:null,indices:null,get:null,set:null,iterator:null,forEach:null,slice:null,reshape:null,concat:null,transpose:null,op:null,toArray:null,toNDArray:null,toString:null},"undefined"!=typeof Symbol&&void 0!==Symbol.iterator&&(V[t][Symbol.iterator]=function(){return this.iterator()}),E[t]={constructor:E,start:null,stop:null,step:null,clone:function(){return new E(this.start,this.stop,this.step)},indices:function(n){return E._indices(n,this.start,this.stop,this.step)},count:function(n){return E._count(n,this.start,this.stop,this.step)},subslice:function(n){return E._subslice(this,n)},toObj:function(){return{start:this.start,stop:this.stop,step:this.step}},toArr:function(){return[this.start,this.stop,this.step]}},E._indices=function(n,t,e,r){return new E(t=null==t?0:(t<0?n:0)+t,e=t+(r=r||1)*k.floor(k.abs((e=null==e?n-1:(e<0?n:0)+e)-t)/k.abs(r)),r)},E._count=function(n,t,e,r){return!n||r<0&&(t<0||t<e)||0<r&&(n<=t||e<t)?0:k.min(n,k.ceil((k.abs(e-t)+1)/k.abs(r)))},E._subslice=function(n,t){var e=n.step||1;return t?new E(n.start+(t.start||0)*e,n.start+t.stop*e,(t.step||1)*e):n instanceof E?n:new E(n.start,n.stop,e)},V.slice=E,V});