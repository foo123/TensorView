/**
*  TensorView
*  View array data as multidimensional tensors of various shapes efficiently
*  @VERSION 1.0.0
*  https://github.com/foo123/TensorView
*
**/
!function(n,t){"use strict";"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(function(n){return t()}):n.TensorView=t()}("undefined"!=typeof self?self:this,function(n){"use strict";var t="prototype",E=Math;function O(s,n,t){if(!(this instanceof O))return new O(s,n,t);var o,l=this,r=!1,u=!1,a=null,f=null,c=null,h=-1,p=null,g=null,d=!1,y=0,i=null,w=null,_=null,v=null,m=!0,A=0;function b(n,t,e,r,i,l,o){var s,u,a=0;if(o)for(s=0;s<t;++s)u=n[s],a+=i[s]*(o[s].start+((u<0?l[s]:0)+u)*o[s].step);else for(s=0;s<t;++s)u=n[s],a+=i[s]*((u<0?l[s]:0)+u);return a}function j(n,t,e,r,i,l,o){var s,u;if(o=o||new Array(t),e)if(l)for(s=0;s<t;++s)u=n%r[s],n=E.floor(n/r[s]),o[s]=E.floor((u-l[s].start)/l[s].step);else for(s=0;s<t;++s)u=n%r[s],n=E.floor(n/r[s]),o[s]=u;else if(l)for(s=t-1;0<=s;--s)u=n%r[s],n=E.floor(n/r[s]),o[s]=E.floor((u-l[s].start)/l[s].step);else for(s=t-1;0<=s;--s)u=n%r[s],n=E.floor(n/r[s]),o[s]=u;return o}function S(n,t,e){for(var r=n,i=t.length-1,l=0;l<i;++l)r=r[t[l]];return 2<arguments.length&&(r[t[i]]=e),r[t[i]]}function x(n,t){if(f)return a?f[1]?a(f[0].get(t),f[1].get(t)):a(f[0].get(t)):f[0].get(f[0].indices(n));if(!c)return g?S(s,m&&d?t:j(n,g.length,!1,g,0,null,p)):u?s:s[n];for(var e=0;e<y;++e)p[e]=v[e].start+t[e]*v[e].step;for(var r,i,e=0,l=c.length;e<l;++e){if(i=(r=c[e]).size(h),0<=p[h]&&p[h]<i)return r.get(p);p[h]-=i}}if(n=n||{},r=!!t&&!!t._transposed,s instanceof O)r=!1,s=(f=[s])[0].data(),A=f[0].length(),i=n.shape||f[0].size(),y=i.length;else if(t&&t._refs&&t._refs[0]instanceof O)r=!1,a=t._op||null,f=t._refs,A=f[0].length(),i=(a?f[0].size():n.shape)||f[0].size(),y=i.length,f[1]&&(s=null),a&&n.slice&&(n.slice=null);else if(t&&t._stack&&2<=t._stack.length&&t._stack[0]instanceof O&&t._stack[1]instanceof O)s=null,h=t._stack_axis||0,c=t._stack,(i=c[0].size())[h]=N(c.map(function(n){return n.size(h)})),A=N(c.map(function(n){return n.length()})),y=i.length,p=new Array(y);else{var A=function(n){{if(Array.isArray(n))return 1;if("undefined"!=typeof Float32Array&&n instanceof Object.getPrototypeOf(Float32Array))return 1}return}(s)?(u=!1,n.ndarray&&n.ndarray.length?(g=n.ndarray,p=new Array(g.length),D(g)):s.length):(u=!0,1),e=D(i=(i=n.shape)&&i.length?i:[A]);if(e!==(A=u?e:A))throw"TensorView:shape ["+i.join(",")+"] does not match size "+String(A);y=i.length,d=!!g&&g.length===i.length&&g.length===i.filter(function(n,t){return n===g[t]}).length}if(w=new Array(y),r)for(var z=w[0]=1;z<y;++z)w[z]=w[z-1]*i[z-1];else{w[y-1]=1;for(z=y-2;0<=z;--z)w[z]=w[z+1]*i[z+1]}if((v=n.slice)&&v.length){for(;v.length<y;)v.push(null);v.length>y&&(v.length=y);for(z=0;z<y;++z){var k=v[z]||{start:0,stop:i[z]-1,step:1};v[z]=k=V._indices(i[z],k.start,k.stop,k.step),0===k.start&&k.stop+1===i[z]&&1===k.step||(m=!1)}}else for(var v=new Array(y),z=0;z<y;++z)v[z]=new V(0,i[z]-1,1);for(_=new Array(y),z=0;z<y;++z)_[z]=v[z].count(i[z]);o=y?D(_):0,n=t=null,l.dispose=function(){_=v=w=i=s=g=p=c=f=a=null},l.data=function(){return s},l.dimension=function(){return y},l.shape=function(n){return arguments.length?i[n]:i.slice()},l.slicing=function(n){return arguments.length?v[n].toObj():v.map(function(n){return n.toObj()})},l.size=function(n){return arguments.length?_[n]:_.slice()},l.length=function(){return o},l.index=function(){return b(Array.isArray(arguments[0])?arguments[0]:arguments,y,0,0,w,_,v)},l.indices=function(n){return j(n,y,r,i,0,v)},l.iterator=function(){var n=0<o?y-1:-1,t=null,e=null,r=0,i=[null,null],l={value:null};return{next:function(){if(n<0)return{done:!(t=e=l=i=null)};if(t){for(;0<=n&&t[n]+1>=_[n];)r-=w[n]*(v[n].start+t[n]*v[n].step),--n;if(!(0<=n))return{done:!(t=e=l=i=null)};for(++t[n],e[n]=t[n],r+=w[n]*v[n].step;n+1<y;)t[++n]=0,e[n]=0,r+=w[n]*v[n].start}else t=new Array(y).fill(0),e=t.slice(),r=b(t,y,0,0,w,_,v);return i[0]=x(r,t),i[1]=e,l.value=i,l}}},l.forEach=function(n){if(0<o&&"function"==typeof n)for(var t,e=l.iterator();;){if(!(t=e.next())||t.done)return;if(!1===n(t.value[0],t.value[1],s,l))return}},l.slice=function(e){return new O(s,{ndarray:g,shape:a&&f?null:i,slice:a&&f?null:v.map(function(n,t){return V._subslice(n,e[t],!0)})},{_transposed:r,_refs:a&&f?f.map(function(n){return n.slice(e)}):f,_op:a,_stack:f?null:c,_stack_axis:h})},l.reshape=function(n){return!m||c||f?new O(l,{shape:n}):new O(s,{ndarray:g,shape:n})},l.concat=function(e,r){r=r||0;for(var i=0,n=(e=e instanceof O?[e]:e).length;i<n;++i)if(_.filter(function(n,t){return t===r||n===e[i].size(t)}).length!==_.length)throw"TensorView::concat:["+_.map(function(n,t){return r===t?":":n}).join(",")+"] and ["+e[i].size().map(function(n,t){return r===t?":":n}).join(",")+"] sizes do not match!";return new O(null,null,{_stack:[l].concat(e),_stack_axis:r})},l.get=function(n){if(n.length<y)throw"TensorView::get:indices do not match shape dimension!";var t=a||c?0:b(n,y,0,0,w,_,v);if(t<0||A<=t)throw"TensorView::get:index out of bounds!";return x(t,n)},l.set=function(n,t){if(n.length<y)throw"TensorView::set:indices do not match shape dimension!";var e=a||c?0:b(n,y,0,0,w,_,v);if(e<0||A<=e)throw"TensorView::set:index out of bounds!";return function(n,t,e){if(f)a||f[0].set(f[0].indices(n),e);else if(c){for(var r=0;r<y;++r)p[r]=v[r].start+t[r]*v[r].step;for(var i,l,r=0,o=c.length;r<o;++r){if(l=(i=c[r]).size(h),0<=p[h]&&p[h]<l)return i.set(p,e);p[h]-=l}}else g?S(s,m&&d?t:j(n,g.length,!1,g,0,null,p),e):u?s=e:s[n]=e}(e,n,t),l},l.transpose=function(){return new O(s,{ndarray:g,shape:i.slice().reverse(),slice:v.map(function(n){return n.toObj()}).reverse()},{_transposed:!r,_refs:f?f.map(function(n){return n.transpose()}).reverse():null,_op:a,_stack:c?c.map(function(n){return n.transpose()}):null,_stack_axis:c?y-1-h:-1})},l.op=function(n,t){return new O(s,null,{_refs:t instanceof O?[l,t]:[l],_op:n})},l.toArray=function(n){var t=new(n||Array)(o),e=0;return l.forEach(function(n){t[e++]=n}),t},l.toNDArray=function(){var o=new Array(_[0]);return l.forEach(function(n,t){for(var e,r=o,i=y-1,l=0;l<i;++l)null==r[e=t[l]]&&(r[e]=new Array(_[l+1])),r=r[e];r[t[i]]=n}),o},l.toString=function(o){var s,u,a,f="",c=-1/0,h=null,p="";return null!=o?(s=o>>>1,2<=y?(u=_.map(function(n){return o<n}),a=function(n,t){return!u[t]||t<=y-3&&(n<s||n>_[t]-1-s)||y-3<t&&(n<=s||n>=_[t]-1-s)},h=new Array(u[_.length-2]?o+1:_[_.length-2]).fill(null).map(function(n){return new Array(u[_.length-1]?o+1:_[_.length-1])}),l.forEach(function(n,t){t.length===t.filter(a).length&&(c=E.max(String(n).length,c))}),l.forEach(function(n,t){if(t.length===t.filter(a).length){var e=t[y-2],r=t[y-1];if(u[y-2]&&s<e&&(e=o-(_[y-2]-1-e)),u[y-1]&&s<r&&(r=o-(_[y-1]-1-r)),h[e][r]=T(String(n),c," ",!1),_[y-1]===1+t[y-1]&&_[y-2]===1+t[y-2]){f+=p+h.map(function(n,t){return u[y-2]&&s===t&&(n=new Array(n.length).fill(T(":",c," ",!1))),u[y-1]&&(n[s]=T("..",c," ",!1)),n.join(" ")}).join("\n");for(var i=y-3,l=-1;0<=i;)l=-1===l&&u[i]&&t[i]+1===s?i:l,--i;p=-1===l?"\n-\n":"\n-\n"+T(":",c," ",!1)+" "+new Array((u[y-1]?o+1:_[y-1])-2).fill(T("..",c," ",!1)).join(" ")+" "+T(":",c," ",!1)+"\n-\n"}}})):f=o>=_[0]?l.toString():l.slice([{start:0,stop:s+1}]).toString()+" .. "+l.slice([{start:_[0]-1-s,stop:_[0]-1}]).toString()):2<=y?(h=new Array(_[_.length-2]).fill(null).map(function(n){return new Array(_[_.length-1])}),l.forEach(function(n){c=E.max(String(n).length,c)}),l.forEach(function(n,t){h[t[y-2]][t[y-1]]=T(String(n),c," ",!1),_[y-1]===1+t[y-1]&&_[y-2]===1+t[y-2]&&(f+=p+h.map(function(n){return n.join(" ")}).join("\n"),p="\n-\n")})):l.forEach(function(n){f+=(f.length?" ":"")+String(n)}),f}}function V(n,t,e){if(!(this instanceof V))return new V(n,t,e);this.start=null==n?null:n,this.stop=null==t?null:t,this.step=null==e?null:e}function T(n,t,e,r){t=n.length<t?new Array(t-n.length+1).join(e):"";return r?n+t:t+n}function e(n,t){return n+t}function r(n,t){return n*t}function N(n){return n.reduce(e,0)}function D(n){return n.reduce(r,1)}return O.VERSION="1.0.0",O[t]={constructor:O,dispose:null,data:null,dimension:null,shape:null,slicing:null,size:null,length:null,index:null,indices:null,iterator:null,forEach:null,slice:null,reshape:null,concat:null,get:null,set:null,transpose:null,op:null,toArray:null,toNDArray:null,toString:null},"undefined"!=typeof Symbol&&void 0!==Symbol.iterator&&(O[t][Symbol.iterator]=function(){return this.iterator()}),V[t]={constructor:V,start:null,stop:null,step:null,clone:function(){return new V(this.start,this.stop,this.step)},indices:function(n){return V._indices(n,this.start,this.stop,this.step)},count:function(n){return V._count(n,this.start,this.stop,this.step)},subslice:function(n){return V._subslice(this,n)},toObj:function(){return{start:this.start,stop:this.stop,step:this.step}}},V._indices=function(n,t,e,r){return new V(t=null==t?0:(t<0?n:0)+t,e=t+(r=r||1)*E.floor(E.abs((e=null==e?n-1:(e<0?n:0)+e)-t)/E.abs(r)),r)},V._count=function(n,t,e,r){return!n||r<0&&(t<0||t<e)||0<r&&(n<=t||e<t)?0:E.min(n,E.ceil((E.abs(e-t)+1)/E.abs(r)))},V._subslice=function(n,t,e){var r=n.step||1;return e?t?{start:n.start+t.start*r,stop:n.start+t.stop*r,step:(t.step||1)*r}:n instanceof V?n.toObj():n:t?new V(n.start+t.start*r,n.start+t.stop*r,(t.step||1)*r):n instanceof V?n:new V(n.start,n.stop,r)},O.slice=V,O});